#!/usr/bin/env bash

program_name="$(basename "$0")"

usage() {
printf "%s" "\
usage: $program_name <command>

commands:
    create          create new tabbed container and add focused window.
    attach <wid>    attach focused window to tabbed container <wid> (if it
                    isn't one, create it first).
    detach          detach focused window from tabbed container.
    autoattach      toggle autoattach new windows to tabbed container (enabled
                    by default).
"

exit 1
}

# Get wid of root window
get_root_wid() {
	xwininfo -root | awk '/Window id:/{print $4}'
}

# Get children of tabbed container
get_children() {
	id=$1
	xwininfo -id $id -children | sed -n '/[0-9]\+ \(child\|children\):/,$s/ \+\(0x[0-9a-z]\+\).*/\1/p'
}

# Get class of a wid
get_class() {
	id=$1
    xprop -id $id 8s '\t$0' WM_CLASS | cut -f2 | tr -d '"'
}

cmd=$1

case $cmd in
    create)
        focusedid=$(bspc query -N -n)

        bspc config -n focused border_width 0

        tabbedid=$(tabbed -c -d -k)

        xdotool windowreparent $focusedid $tabbedid

        tabbedid0=$(bspc query -N -n) 

        tabbed-sub "$tabbedid0" &
        tabbed-unsub "$tabbedid0" &
        ;;
	add)
		focusedid=$(bspc query -N -n)
        otherid=$(bspc query -N -n $2)

        [[ -z $otherid ]] && exit 1

        if [[ "$(get_class $otherid)" != "tabbed" ]]; then
            bspc config -n $otherid border_width 0

            tabbedid=$(tabbed -c -d -k)

            xdotool windowreparent $otherid $tabbedid

            tabbedid0=$(bspc query -N -n)

            tabbed-sub "$tabbedid0" &
            tabbed-unsub "$tabbedid0" &
        else
            tabbedid=$otherid
        fi

        bspc config -n $focusedid border_width 0

		xdotool windowreparent $focusedid $tabbedid
		;;
	remove)
        tabbedid=$(bspc query -N -n focused)

        [[ "$(get_class $tabbedid)" == "tabbed" ]] || exit 1

        tabbedsub_px=$(pgrep -P $(pgrep -fo "tabbed-sub $tabbedid") -f "bspc")
        
        kill $tabbedsub_px

        childid=$(get_children $tabbedid | head -n1)
        rootid=$(get_root_wid)

		xdotool windowreparent $childid $rootid

        tabbed-sub "$tabbedid" &
		;;
esac
